# CSRF

Οι επιθέσεις CSRF μπορούν να είναι χρήσιμες για τον αντίπαλο, αν κάποιος χρήστης συνδεδεμένος στο site, κάνει κλικ σε ένα link το οποίο να αντιστοιχεί σε σελίδα η οποία συμπληρώνει μία ψεύτικη φόρμα που επιφέρει αλλαγές που κανονικά θα έπρεπε να έχει αιτηθεί το site. Η σελίδα του eclass δεν είχε απολύτως καμία προστασία ενάντια σε επιθέσεις CSRF.

## Defence

Αποφασίσαμε σε κάθε φόρμα να αμυνθούμε με την τεχνική των __CSRF tokens__. Στο index.php, στο οποίο μπαίνει ο χρήστης με το που συνδέεται στο eclass, δημιουργούμε μία global μεταβλητή που κρατάει ένα randomly generated token, συγκεκριμένα στην μεταβλητή `$_SESSION['token']`. Έπειτα, κάθε φορά που δημιουργείται μία νέα φόρμα για κάποια λειτουργία του eclass(συνήθως γίνεται append στην μεταβλητή `$toolContent`), προσθέτουμε σαν κρυφό πεδίο μία μεταβλητή `form_token`, οπου παίρνει την τιμή του token που προηγουμένως έχει γίνει generate. Τέλος, όταν η εκάστοτε σελίδα επεξεργάζεται την φόρμα που έχει λάβει, καλεί την συνάρτηση `check_token()`, και εκτελεί την ενέργεια υπό την προυπόθεση οτι αυτή η συνάρτηση επιστρέφει True. Η συνάρτηση αυτή, είναι υλοποιημένη στο αρχείο `include/lib/main.lib.php`, μαζί με άλλες συναρτήσεις για λόγους ασφαλείας, και ελέγχει αν υπάρχει token στην φόρμα, και αν η τιμή του token της φόρμας είναι ίση με την μεταβλητή `$_SESSION['token']`. 

Ένα άλλο μέτρο που πήραμε για να ασφαλήσουμε την εφαρμοη μας απο CSRF επιθέσεις ήταν __να αλλάξουμε το όνομα του φακέλου στο οποίο βρίσκεται το περιεχόμενο του διαχειριστή__, απο admin σε eclass_admin. Γνωρίζουμε πως οι αντίπαλοι είχαν εκ των πρωτέρων εμπειρία για το που βρίσκονται τα links για σελίδες με φόρμες(τα οποία είναι κυρίως σε σελίδες διαχεριστή). Επομένως, με το να αλλάξουμε το όνομα του φακέλου, το οποίο δεν μπορεί να γίνει γνωστό σε αυτούς καθώς έχουν regular χρήστη που δεν έχει πρόσβαση σε περιεχόμενο admin, αχρηστεύουμε όλα τα forms τα οποία θα απευθύνουν προς σελίδες προς κάποιο αρχείο στον φάκελο admin, καθώς απλά πετάει 404 στον deunkadmin όταν κάνει κλικ σε μία τέτοια φόρμα.

## Attack

Για να επιτεθούμε με επιθέσεις CSRF, έπρεπε να βρούμε όλα τα σημεία τα οποία περιέχουν φόρμες στην ιστοσελίδα του eclass. Τα αρχεία αυτά είναι τα παρακάτω:

 - modules/coach/edituser.php
 - modules/coach/newuseradmin.php
 - modules/coach/change_user.php
 - modules/coach/addfaculte.php
 - modules/coach/adminannouncements.php
 - modules/coach/eclassconf.php
 - modules/create_course/create_course.php
 - modules/profile/profile.php
 - modules/profile/password.php (?)
 - modules/announcements/announcements.php
 - modules/work/work.php
 - modules/dropbox/index.php
 - modules/phpbb/newtopic.php
 - modules/course_info/infocours.php

(++ Προσθηκη xss σε όλα)


Για κάθε ένα από αυτά, δημιουργήσαμε μία φόρμα με action το domain των αντιπάλων μας. Επίσης, η φόρμα αυτή μπορεί να προσαρμοστεί ως εξής: Αν περιηγηθούμε με τα developer tools στο site των αντιπάλων μας, μπορούμε να δούμε τα responses μιας σελίδας με φόρμα, ώστε να δούμε αν υπάρχει κάποιο token που έχουν βάλει οι αντίπαλοί μας, και να δούμε κατα πόσον αυτό ειναι στατικό. Όλες οι φόρμες που δημιουργήσαμε βρίσκονται στο domain `hack-n-roll.puppies.chatzi.org` και αποστάλθηκαν με mail στον drunkadmin.

## Disable

 - modules/coach/search_user.php
 - modules/coach/userstats.php?u=2
 - modules/coach/listreq.php
 - modules/coach/listreq.php
 - modules/coach/auth.php
 - modules/coach/multireguser.php
 - modules/coach/mailtoprof.php
 - modules/coach/searchcours.php
 - modules/course_info/restore_course.php
 - modules/coach/adminannouncements.php
 - modules/coach/stateclass.php
 - modules/agenda/myagenda.php
 - modules/profile/personal_stats.php
 - modules/help/help.php