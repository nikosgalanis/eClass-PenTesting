# File Injections

Οι RFI επιθέσεις μπορούν να χρησιμοποιηθούν ώστε ο απιτηθέμενος να καταφέρει να εκτελέσει κώδικα στο αντίπαλο site. Ο κώδικας αυτός, προέρχεται από τον ίδιο, μέσω αρχείων που έχει ανεβάσει στο domain. Στο eclass τα διαθέσιμα μέρη για ανέβασμα αρχείων ήταν οι __Εργασίες__ και η __Ανταλλαγή Αρχείων__. Κανένα απο αυτά τα 2 modules δεν ήταν καλά προστατευμένο απο File Injections, καθώς ο χρήστης μπορούσε ανενόχλητος να ανεβάσει ό,τι τύπου αρχείο ήθελε, και στην συνέχεια να το εκτελέσει, πηγαίνοντας στο link του αρχείου, στο οποίο εκ πρώτης όψεως δεν είχε πρόσβαση.

Όμως, μέσω του κώδικα στο αρχείο `modules/dropbox/dropbox_init1.inc.php`, είδαμε πως τα αρχεία της ανταλλαγής αρχείων βρίσκονται στον φάκελο `courses/<course_id>/dropbox/`, επομένως μέσα από εκεί θα μπορούσαμε να εκτελέσουμε το αρχείο το οποίο ανεβάσαμε, μέσα στον server. 

Αντίστοιχα, τα αρχεία που ανεβάζουν οι χρήστες για τις εργασίες, βρίσκονται στον κατάλογο `courses/<course_id>/work/`.

Και στις 2 περιπτώσεις, για "ασφάλεια", τα αρχεία και οι φάκελοι στα οποία μπαίνουν, παίρνουν τυχαίο όνομα, που όμως δεν έχει καμία σημασία, εφόσον μπορούμε να περιηγηθούμε στο δέντρο των καταλόγων του site. Επίσης, το όνομα αυτό αποθηκεύεται στην βάση δεδομένων, στο πεδίο secret_direcotry του πίνακα assignments, στο οποίο θα μπορούσαμε να αποκτήσουμε πρόσβαση με κάποιο sql injection.

Επίσης στο site μπορούν να γίνουν και Local file injections, αν ο αντίπαλος προσπαθήσει απο το url να κάνει include κάποιο αρχείο του server μας.

## Defence

Για να αντιμετωπιστεί το πρόβλημα που αναφέρθηκε παραπάνω, κάναμε τα εξής:

 - Δημιουργήσαμε ένα αρχείο `.htaccess`, το οποίο απενεργοποιούσε την δυνατότητα να φαίνεται το δέντρο των καταλόγων, και επομένως, σε συνδυασμό με το ότι τα ονόματα των φακέλων είναι τυχαία, ο αντίπαλος δεν θα μπορούσε να βρεί την τοποθεσία των αρχείων που ανέβασε ώστε να τα τρέξει.
 - Φιλτράραμε το ανέβασμα των αρχείων, ώστε να μην επιτρέπεται να ανέβουν αρχεία με suspicious καταλήξεις, όπως `.php`, `.js`, `.sh` κλπ, ώστε ακόμα και αν με κάποιον τρόπο ο αντίπαλος αποκτούσε πρόσβαση στον φάκελο, να μην μπορούσε να τρέξει τα αρχεία.
 - Πραγματοποιήσαμε αλλαγές σε ονόματα κρίσιμων φακέλων, αρχείων και μεταβλητών ώστε στην περίπτωση που κάποιος κατάφερνε να έχει πρόσβαση, να μην καταφέρει να τις βρει.
 - Σκανάραμε το site για περιπτώσεις που σε include έμπαινε μεταβλητή που είχε εισάγει ο χρήστης, και αποτρέψαμε την εισαγωγή του "../", το οποίο πιθανώς να οδηγούσε σε φάκελο που δεν έπρεπε μέσα στο domain.

## Attack

Εκμεταλλευόμενοι τις ευπάθειες της ιστοσελίδας, αλλά και τα μέρη στα οποία επιτρεπόταν το ανέβασμα αρχείων, δημιουργήσαμε μερικά scripts, με τα οποία προσπαθήσαμε να αποκτήσουμε πρόσβαση σε κωδικούς και να τους αλλάξουμε. Τα αρχεία αυτά βρίσκονται στον φάκελο `attacks/rfi/attacks/`, και επιτελούν τις εξής λειτουργίες:

 - `show_db_password.php`: Εφ'όσον γνωρίζουμε σε ποιό αρχείο αποθηκεύεται το username και ο κωδικός πρόσβασης στην βάση δεδομένων, προσπαθούμε να αποκτήσουμε πρόσβαση σε αυτό το αρχείο, και να εκτυπώσουμε τις μεταβλητές `$mysqlUser` και `$mysqlPassword`. 
 - `change_password.php`: Προσπαθούμε να εκτελέσουμε ένα query στην βάση, ώστε να αλλάξουμε τον κωδικό όλων των χρηστών. Γνωρίζοντας το όνομα της βάσης, όπως έχει οριστεί στο `config.php`, αποκτούμε εύκολα πρόσβαση σε αυτήν, και εκτελούμε την ενημέρωση που θέλουμε στην βάση.